metadata:
  name: geekbench-cpu-multi
  format: "Lava-Test Test Definition 1.0"
  description: >
    Geekbench 6 CPU multi-core only run (multi-thread workloads) with live progress,
    per-iteration logs and CSV dumps. Supports cpu-workers control.
  os:
    - linux
  scope:
    - performance
    - functional

params:
  OUT_DIR: "./logs_Geekbench_Multi"
  RUNS: "1"
  HEARTBEAT_SECS: "15"
  CORE_LIST: ""
  SET_PERF_GOV: "1"
  GEEKBENCH_BIN: "geekbench_aarch64"

  NO_UPLOAD: "1"
  UPLOAD: "0"

  # Multi-core controls
  CPU_WORKERS: "" # e.g. "8" (if empty, Geekbench defaults)
  GB_ITERATIONS: "" # geekbench --iterations (internal)
  WORKLOAD_GAP: "" # ms

  EXPORT_TEXT_FILE: ""
  EXTRA_ARGS: ""
  STANDALONE: "0"

run:
  steps:
    - REPO_PATH=$PWD
    - cd Runner/suites/Performance/Geekbench/
    - ./run.sh \
       --outdir "$OUT_DIR" \
       --runs "$RUNS" \
       --core-list "${CORE_LIST:-}" \
       --bin "$GEEKBENCH_BIN" \
       --progress-heartbeat "$HEARTBEAT_SECS" \
       $( [ "$SET_PERF_GOV" = "1" ] && true || echo --no-perf-gov ) \
       $( [ "$NO_UPLOAD" = "1" ] && echo --no-upload || true ) \
       $( [ "$UPLOAD" = "1" ] && echo --upload || true ) \
       --cpu \
       --multi-core \
       $( [ -n "$CPU_WORKERS" ] && echo --cpu-workers "$CPU_WORKERS" || true ) \
       $( [ -n "$GB_ITERATIONS" ] && echo --iterations "$GB_ITERATIONS" || true ) \
       $( [ -n "$WORKLOAD_GAP" ] && echo --workload-gap "$WORKLOAD_GAP" || true ) \
       $( [ -n "$EXPORT_TEXT_FILE" ] && echo --export-text "$EXPORT_TEXT_FILE" || true ) \
       -- ${EXTRA_ARGS:-} \
       || true
    - $REPO_PATH/Runner/utils/send-to-lava.sh Geekbench.res
