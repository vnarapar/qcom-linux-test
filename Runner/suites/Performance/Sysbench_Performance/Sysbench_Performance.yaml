metadata:
  name: sysbench-performance
  format: "Lava-Test Test Definition 1.0"
  description: "Sysbench performance suite (CPU / memory / threads / mutex + fileio seqwr/seqrd/rndwr/rndrd) with per-iteration logs + summary averages + optional baseline gating."
  os:
    - linux
  scope:
    - performance
    - functional

params:
  OUT_DIR: "./logs_Sysbench_Performance"

  # Iteration controls
  ITERATIONS: "3"
  TIME: "30"
  RAND_SEED: "1234"
  THREADS_LIST: "4"

  # CPU
  CPU_MAX_PRIME: "20000"

  # Threads test
  THREAD_LOCKS: "20"
  THREAD_YIELDS: ""

  # Memory test
  MEMORY_OPER: "write"
  MEMORY_ACCESS_MODE: "rnd"
  MEMORY_BLOCK_SIZE: "1M"
  MEMORY_TOTAL_SIZE: "100G"

  # Mutex test
  MUTEX_NUM: ""
  MUTEX_LOCKS: ""
  MUTEX_LOOPS: ""

  # Core pinning (optional)
  TASKSET_CPU_LIST: ""

  # Baselines + thresholds (optional gating)
  BASELINE_FILE: ""
  ALLOWED_DEVIATION: "0.10"

  # Optional CSV append
  CSV_FILE: ""

  VERBOSE: "0"

  # ---------------- FileIO (storage-backed) ----------------
  FILEIO_DIR: "/var/tmp/sysbench_fileio"
  FILEIO_TOTAL_SIZE: "1G"
  FILEIO_NUM: "64"
  FILEIO_BLOCK_SIZE: "4K"
  FILEIO_IO_MODE: "sync"
  FILEIO_FSYNC_FREQ: "0"
  FILEIO_EXTRA_FLAGS: "none"

  # If/when run.sh supports it:
  # FILEIO_MODE_LIST: "seqwr seqrd rndwr rndrd"

run:
  steps:
    - REPO_PATH=$PWD
    - cd Runner/suites/Performance/Sysbench_Performance/

    # Explicitly forward params to run.sh (best practice)
    - >
      ./run.sh
      --OUT_DIR "$OUT_DIR"
      --ITERATIONS "$ITERATIONS"
      --TIME "$TIME"
      --RAND_SEED "$RAND_SEED"
      --THREADS_LIST "$THREADS_LIST"
      --CPU_MAX_PRIME "$CPU_MAX_PRIME"
      --THREAD_LOCKS "$THREAD_LOCKS"
      --THREAD_YIELDS "$THREAD_YIELDS"
      --MEMORY_OPER "$MEMORY_OPER"
      --MEMORY_ACCESS_MODE "$MEMORY_ACCESS_MODE"
      --MEMORY_BLOCK_SIZE "$MEMORY_BLOCK_SIZE"
      --MEMORY_TOTAL_SIZE "$MEMORY_TOTAL_SIZE"
      --MUTEX_NUM "$MUTEX_NUM"
      --MUTEX_LOCKS "$MUTEX_LOCKS"
      --MUTEX_LOOPS "$MUTEX_LOOPS"
      --TASKSET_CPU_LIST "$TASKSET_CPU_LIST"
      --BASELINE_FILE "$BASELINE_FILE"
      --ALLOWED_DEVIATION "$ALLOWED_DEVIATION"
      --CSV_FILE "$CSV_FILE"
      --VERBOSE "$VERBOSE"
      --FILEIO_DIR "$FILEIO_DIR"
      --FILEIO_TOTAL_SIZE "$FILEIO_TOTAL_SIZE"
      --FILEIO_NUM "$FILEIO_NUM"
      --FILEIO_BLOCK_SIZE "$FILEIO_BLOCK_SIZE"
      --FILEIO_IO_MODE "$FILEIO_IO_MODE"
      --FILEIO_FSYNC_FREQ "$FILEIO_FSYNC_FREQ"
      --FILEIO_EXTRA_FLAGS "$FILEIO_EXTRA_FLAGS"
      || true

    - $REPO_PATH/Runner/utils/send-to-lava.sh Sysbench_Performance.res
